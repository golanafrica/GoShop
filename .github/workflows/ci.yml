# .github/workflows/ci.yml
name: GoShop CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  GO_VERSION: '1.25'

jobs:
  test:
    name: Run Unit Tests (mocked only)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run mocked unit tests only
        run: |
          go test -v -race -coverprofile=coverage.out \
            $(go list ./... | \
              grep -v /tests$ | \
              grep -v /tests/ | \
              grep -v /infrastructure/postgres | \
              grep -v /application/usecase/order_usecase | \
              grep -v /application/usecase/auth_usecase)

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.out
          flags: unittests

  integration-test:
    name: Run Integration Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: root
          POSTGRES_DB: goshop_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install PostgreSQL client
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Wait for services
        run: |
          for i in {1..30}; do
            if pg_isready -h localhost -p 5432 -U postgres && redis-cli -h localhost -p 6379 ping > /dev/null 2>&1; then
              break
            fi
            sleep 2
          done

      - name: Create .env.test
        run: |
          cat > .env.test << 'EOF'
          APP_ENV=test
          APP_PORT=8081
          DB_HOST=localhost
          DB_PORT=5432
          DB_USER=postgres
          DB_PASSWORD=root
          DB_NAME=goshop_test
          DB_SSLMODE=disable
          REDIS_HOST=localhost
          REDIS_PORT=6379
          BCRYPT_COST=4
          EOF

      - name: Run integration tests
        run: |
          cd tests
          go test -v -tags=integration ./...

  e2e-test:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    services:  # ← OBLIGATOIRE
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: root
          POSTGRES_DB: goshop_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install PostgreSQL client
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Wait for services
        run: |
          for i in {1..30}; do
            if pg_isready -h localhost -p 5432 -U postgres && redis-cli -h localhost -p 6379 ping > /dev/null 2>&1; then
              break
            fi
            sleep 2
          done

      - name: Create .env.test
        run: |
          cat > .env.test << 'EOF'
          APP_ENV=test
          APP_PORT=8081
          DB_HOST=localhost
          DB_PORT=5432
          DB_USER=postgres
          DB_PASSWORD=root
          DB_NAME=goshop_test
          DB_SSLMODE=disable
          REDIS_HOST=localhost
          REDIS_PORT=6379
          BCRYPT_COST=4
          EOF

      - name: Run E2E tests
        run: go test -v ./tests/e2e/...

  build:
    name: Build & Generate Docs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download dependencies
        run: |
          go mod download
          go mod tidy

      - name: Install Swag
        run: go install github.com/swaggo/swag/cmd/swag@latest

      - name: Create minimal .env
        run: echo "APP_ENV=development" > .env

      - name: Generate OpenAPI documentation
        run: |
          cd cmd/api
          swag init -g main.go --output ../../docs --parseDependency --parseInternal
          cd ../..
          test -f docs/docs.go
          echo "✅ OpenAPI docs generated"

      - name: Build API binary
        env:
          CGO_ENABLED: 0
        run: |
          go build -v -ldflags="-w -s" -o goshop-api ./cmd/api
          ./goshop-api --help || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: goshop-api
          path: |
            goshop-api
            docs/

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run gosec (ignore tests)
        run: |
          go mod download
          docker run --rm -v $PWD:/src -w /src securego/gosec -exclude-dir=tests ./...

  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'  # ← Compatible avec golangci-lint
          cache: true

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          args: --timeout=5m --exclude-dir=tests