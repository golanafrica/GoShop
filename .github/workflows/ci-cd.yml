# .github/workflows/ci-cd.yml
name: GoShop CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  GO_VERSION: '1.25'
  DOCKER_IMAGE: ghcr.io/golanafrica/goshop  # â† namespace du repo

jobs:
  test:
    name: Run Unit Tests (mocked only)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run mocked unit tests only
        run: |
          go test -v -coverprofile=coverage.out \
            $(go list ./... | \
              grep -v /tests$ | \
              grep -v /tests/ | \
              grep -v /usecase/order_usecase | \
              grep -v /usecase/auth_usecase | \
              grep -v /infrastructure/postgres) || true

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./coverage.out
          flags: unittests
          fail_ci_if_error: false
        continue-on-error: true

  integration-test:
    name: Run Integration Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: root
          POSTGRES_DB: goshop_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install PostgreSQL client and Redis tools
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client redis-tools

      - name: Wait for services
        run: |
          echo "â³ Waiting for services..."
          for i in {1..30}; do
            if pg_isready -h localhost -p 5432 -U postgres 2>/dev/null && \
               redis-cli -h localhost -p 6379 ping 2>/dev/null | grep -q PONG; then
              echo "âœ… All services ready!"
              break
            fi
            echo "Attempt $i/30..."
            sleep 2
          done

      - name: Create .env.test
        run: |
          cat > .env.test << 'EOF'
          APP_ENV=test
          APP_PORT=8081
          DB_HOST=localhost
          DB_PORT=5432
          DB_USER=postgres
          DB_PASSWORD=root
          DB_NAME=goshop_test
          DB_SSLMODE=disable
          REDIS_HOST=localhost
          REDIS_PORT=6379
          BCRYPT_COST=4
          EOF

      - name: Download dependencies
        run: go mod download

      - name: Run integration tests
        run: |
          if [ -d "tests" ]; then
            cd tests
            go test -v -tags=integration ./... || echo "âš ï¸ Some integration tests failed"
          else
            echo "âš ï¸ No tests directory found"
          fi

  e2e-test:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: root
          POSTGRES_DB: goshop_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client redis-tools

      - name: Wait for services
        run: |
          for i in {1..30}; do
            if pg_isready -h localhost -p 5432 -U postgres 2>/dev/null && \
               redis-cli -h localhost -p 6379 ping 2>/dev/null | grep -q PONG; then
              echo "âœ… Services ready"
              break
            fi
            sleep 2
          done

      - name: Create .env.test
        run: |
          cat > .env.test << 'EOF'
          APP_ENV=test
          APP_PORT=8081
          DB_HOST=localhost
          DB_PORT=5432
          DB_USER=postgres
          DB_PASSWORD=root
          DB_NAME=goshop_test
          DB_SSLMODE=disable
          REDIS_HOST=localhost
          REDIS_PORT=6379
          BCRYPT_COST=4
          EOF

      - name: Download dependencies
        run: go mod download

      - name: Run E2E tests
        run: go test -v ./tests/e2e/... || echo "âš ï¸ Some E2E tests failed"

  build:
    name: Build & Generate Docs
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Verify project structure
        run: |
          echo "ğŸ“ Project root:"
          ls -la
          echo ""
          echo "ğŸ“‚ cmd/api exists:"
          test -d cmd/api && echo "âœ… YES" || echo "âŒ NO"
          echo ""
          echo "ğŸ“„ cmd/api/main.go exists:"
          test -f cmd/api/main.go && echo "âœ… YES" || echo "âŒ NO"
          echo ""
          echo "ğŸ“‚ docs directory:"
          test -d docs && ls -la docs/ || echo "docs directory will be created"

      - name: Download dependencies
        run: |
          go mod download
          go mod verify

      - name: Install Swag
        run: |
          go install github.com/swaggo/swag/cmd/swag@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Verify Swag installation
        run: |
          export PATH=$PATH:$(go env GOPATH)/bin
          which swag
          swag --version

      - name: Create .env file
        run: |
          cat > .env << 'EOF'
          APP_ENV=development
          APP_PORT=8080
          DB_HOST=localhost
          DB_PORT=5432
          DB_USER=postgres
          DB_PASSWORD=root
          DB_NAME=goshop
          DB_SSLMODE=disable
          REDIS_HOST=localhost
          REDIS_PORT=6379
          BCRYPT_COST=4
          EOF

      - name: Generate Swagger documentation
        run: |
          export PATH=$PATH:$(go env GOPATH)/bin
          
          echo "ğŸ“š Generating Swagger documentation..."
          echo "Current directory: $(pwd)"
          
          swag init \
            --generalInfo ./cmd/api/main.go \
            --dir ./ \
            --output ./docs \
            --parseDependency \
            --parseInternal \
            --parseDepth 3 || {
              echo "âš ï¸ Swagger generation failed"
              exit 1
            }
          
          echo ""
          echo "âœ… Checking generated files..."
          ls -la docs/

      - name: Verify documentation files
        run: |
          test -f docs/docs.go || (echo "âŒ docs/docs.go missing" && exit 1)
          test -f docs/swagger.json || (echo "âŒ swagger.json missing" && exit 1)
          test -f docs/swagger.yaml || (echo "âŒ swagger.yaml missing" && exit 1)
          echo "âœ… All documentation files generated successfully!"

      - name: Build API binary
        env:
          CGO_ENABLED: 0
          GOOS: linux
          GOARCH: amd64
        run: |
          echo "ğŸ”¨ Building GoShop API..."
          go build \
            -v \
            -ldflags="-w -s" \
            -o goshop-api \
            ./cmd/api
          
          echo "âœ… Build completed!"
          ls -lh goshop-api
          file goshop-api

      - name: Test binary
        run: |
          test -f goshop-api || (echo "âŒ Binary not found" && exit 1)
          test -x goshop-api || (echo "âŒ Binary not executable" && exit 1)
          
          timeout 3s ./goshop-api || true
          
          echo "âœ… Binary is valid and executable!"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: goshop-build
          path: |
            goshop-api
            docs/
          retention-days: 7

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download dependencies
        run: |
          go mod download
          go mod tidy
          go mod verify

      - name: Run gosec security scanner
        run: |
          echo "ğŸ”’ Running security scan..."
          docker run --rm \
            -v "$PWD:/src" \
            -w /src \
            securego/gosec:latest \
            -fmt=json \
            -out=gosec-report.json \
            -exclude-dir=tests \
            -exclude=G104 \
            ./... || true
          
          if [ -f gosec-report.json ]; then
            echo "ğŸ“Š Security scan completed"
            cat gosec-report.json | head -30
          fi
        continue-on-error: true

      - name: Upload security report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report
          path: gosec-report.json
          retention-days: 30

  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          args: --timeout=10m --issues-exit-code=0 --skip-dirs=tests
        continue-on-error: true

  docker:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: [build, security, lint]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: golanafrica
          password: ${{ secrets.CR_PAT }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,format=long,priority=100
            type=ref,event=branch
            type=ref,event=pr

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  docker-security:
    name: Docker Security Scan
    runs-on: ubuntu-latest
    needs: docker
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKER_IMAGE }}:latest
          format: table
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'